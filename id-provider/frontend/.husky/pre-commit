#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the root directory (zero-auth)
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check for backend Ruby files in staging area (in id-provider directory)
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^id-provider/.*\.rb$' | grep -v '^id-provider/frontend/' || true)

# Run RuboCop on staged backend files if any exist
if [ -n "$BACKEND_FILES" ]; then
  echo "Running RuboCop on backend files..."
  # Remove id-provider/ prefix for Docker container paths
  CONTAINER_FILES=$(echo "$BACKEND_FILES" | sed 's|^id-provider/||g')
  cd id-provider
  docker compose exec -T web bundle exec rubocop $CONTAINER_FILES
  if [ $? -ne 0 ]; then
    echo "❌ RuboCop failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ RuboCop passed!"
  cd "$REPO_ROOT"
fi

# Run frontend lint-staged
if git diff --cached --name-only --diff-filter=ACM | grep -q '^id-provider/frontend/'; then
  echo "Running frontend lint-staged..."
  cd id-provider/frontend
  npx lint-staged
  if [ $? -ne 0 ]; then
    echo "❌ Frontend lint failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ Frontend lint passed!"
fi
