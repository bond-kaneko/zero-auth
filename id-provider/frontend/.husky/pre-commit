#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get the root directory (zero-auth)
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check for backend Ruby files in staging area (in id-provider directory)
# Exclude db/schema.rb and db/migrate files
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^id-provider/.*\.rb$' | grep -v '^id-provider/frontend/' | grep -v '^id-provider/db/schema\.rb$' | grep -v '^id-provider/db/migrate/' || true)

# Run RuboCop and RSpec on staged backend files if any exist
if [ -n "$BACKEND_FILES" ]; then
  echo "Running RuboCop on backend files..."
  # Remove id-provider/ prefix for Docker container paths
  CONTAINER_FILES=$(echo "$BACKEND_FILES" | sed 's|^id-provider/||g')
  cd id-provider
  docker compose exec -T web bundle exec rubocop $CONTAINER_FILES
  if [ $? -ne 0 ]; then
    echo "❌ RuboCop failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ RuboCop passed!"

  echo "Running RSpec tests with coverage check..."
  docker compose exec -T web bundle exec rspec
  if [ $? -ne 0 ]; then
    echo "❌ RSpec tests failed or coverage is below 80%. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ RSpec tests and coverage check passed!"
  cd "$REPO_ROOT"
fi

# Check for membership Ruby files in staging area
# Exclude db/schema.rb and db/migrate files
MEMBERSHIP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^service-provider/membership/.*\.rb$' | grep -v '^service-provider/membership/db/schema\.rb$' | grep -v '^service-provider/membership/db/migrate/' || true)

# Run RuboCop and RSpec on staged membership files if any exist
if [ -n "$MEMBERSHIP_FILES" ]; then
  echo "Running RuboCop on membership files..."
  # Remove service-provider/membership/ prefix for Docker container paths
  CONTAINER_FILES=$(echo "$MEMBERSHIP_FILES" | sed 's|^service-provider/membership/||g')
  cd service-provider/membership
  docker compose exec -T web bundle exec rubocop $CONTAINER_FILES
  if [ $? -ne 0 ]; then
    echo "❌ RuboCop failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ RuboCop passed!"

  echo "Running RSpec tests with coverage check..."
  docker compose exec -T web bundle exec rspec
  if [ $? -ne 0 ]; then
    echo "❌ RSpec tests failed or coverage is below 80%. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ RSpec tests and coverage check passed!"
  cd "$REPO_ROOT"
fi

# Run frontend lint-staged
if git diff --cached --name-only --diff-filter=ACM | grep -q '^id-provider/frontend/'; then
  echo "Running frontend lint-staged..."
  cd id-provider/frontend
  npx lint-staged
  if [ $? -ne 0 ]; then
    echo "❌ Frontend lint failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ Frontend lint passed!"
  cd "$REPO_ROOT"
fi

# Run membership frontend lint-staged
if git diff --cached --name-only --diff-filter=ACM | grep -q '^service-provider/membership/frontend/'; then
  echo "Running membership frontend lint-staged..."
  cd service-provider/membership/frontend
  npx lint-staged
  if [ $? -ne 0 ]; then
    echo "❌ Membership frontend lint failed. Please fix the issues before committing."
    exit 1
  fi
  echo "✅ Membership frontend lint passed!"
  cd "$REPO_ROOT"
fi
